variables:
  DOCKER_IMAGE_KUBERNETES_DEPLOY: daohoangson/kubernetes-deploy:0.23.0
  GIT_DEPTH: 1
  K8S_NAMESPACE: xfrocks-using-k8s-$CI_COMMIT_REF_SLUG

deploy_review:
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://$CI_COMMIT_REF_SLUG.using-k8s.xfrocks.com
    on_stop: stop_review
  image: $DOCKER_IMAGE_KUBERNETES_DEPLOY
  script: ./_files/gitlab/deploy.sh
  only:
    - merge_requests

stop_review:
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  image: $DOCKER_IMAGE_KUBERNETES_DEPLOY
  variables:
    GIT_STRATEGY: none
  script:
    - kubectl-config.sh
    - kubectl delete ns/$K8S_NAMESPACE
  when: manual
